services:
  redis:
    image: redis:7.2-alpine
    ports:
      - "6381:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: meme25
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  vault:
    image: hashicorp/vault:1.15
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: myroot
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_ADDR: http://127.0.0.1:8200
      VAULT_API_ADDR: http://127.0.0.1:8200
    ports:
      - "8200:8200"
    healthcheck:
      test: ["CMD-SHELL", "vault status -address=http://127.0.0.1:8200"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Build all Rust services from unified image
  executor:
    build:
      context: .
      dockerfile: Dockerfile.unified
      target: executor
    ports:
      - "8080:8080"
    env_file: .env
    environment:
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/meme25
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=${VAULT_TOKEN:-myroot}
      - SOLANA_RPC_URL=${SOLANA_RPC_URL}
      - SOLANA_WS_URL=${SOLANA_WS_URL}
      - HELIUS_API_KEY=${HELIUS_API_KEY}
      - JUPITER_API_KEY=${JUPITER_API_KEY}
      - PUMP_FUN_API_KEY=${PUMP_FUN_API_KEY}
      - BIRDEYE_API_KEY=${BIRDEYE_API_KEY}
      - TWITTER_BEARER_TOKEN=${TWITTER_BEARER_TOKEN}
      - FARCASTER_API_KEY=${FARCASTER_API_KEY}
      - SOLANA_PRIVATE_KEY=${SOLANA_PRIVATE_KEY}
      - INITIAL_CAPITAL=${INITIAL_CAPITAL:-200}
      - MAX_PORTFOLIO_SIZE=${MAX_PORTFOLIO_SIZE:-2000}
      - MAX_POSITION_SIZE=${MAX_POSITION_SIZE:-2}
      - MAX_DAILY_DRAWDOWN=${MAX_DAILY_DRAWDOWN:-5}
      - PORTFOLIO_STOP_LOSS=${PORTFOLIO_STOP_LOSS:-10}
      - GENETIC_POPULATION_SIZE=${GENETIC_POPULATION_SIZE:-20}
      - GENETIC_MUTATION_RATE=${GENETIC_MUTATION_RATE:-0.1}
      - GENETIC_CROSSOVER_RATE=${GENETIC_CROSSOVER_RATE:-0.7}
      - GENETIC_ELITISM_RATE=${GENETIC_ELITISM_RATE:-0.2}
      - SIGNER_URL=${SIGNER_URL:-http://localhost:9000}
      - JITO_TIP_LAMPORTS=${JITO_TIP_LAMPORTS:-0}
      - MAX_SLIPPAGE=${MAX_SLIPPAGE:-1.0}
      - MIN_LIQUIDITY=${MIN_LIQUIDITY:-10000}
      - TARGET_ANNUAL_RETURN=${TARGET_ANNUAL_RETURN:-500}
      - METRICS_PORT=${METRICS_PORT:-9100}
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      vault:
        condition: service_healthy
    restart: unless-stopped

  portfolio_manager:
    build:
      context: .
      dockerfile: Dockerfile.unified
      target: portfolio_manager
    ports:
      - "8081:8081"
    environment:
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/meme25
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: unless-stopped

  market_data_gateway:
    build:
      context: .
      dockerfile: Dockerfile.unified
      target: market_data_gateway
    ports:
      - "8082:8082"
    env_file: .env
    environment:
      - REDIS_URL=redis://redis:6379
      - HELIUS_API_KEY=${HELIUS_API_KEY}
      - MKT_ENABLE_TRENDING=${MKT_ENABLE_TRENDING:-true}
      - MKT_TRENDING_TOP_N=${MKT_TRENDING_TOP_N:-10}
      - MKT_TRENDING_INTERVAL_SEC=${MKT_TRENDING_INTERVAL_SEC:-45}
      - MKT_ENABLE_NEWPAIRS=${MKT_ENABLE_NEWPAIRS:-true}
      - MKT_NEWPAIRS_TOP_N=${MKT_NEWPAIRS_TOP_N:-15}
      - MKT_NEWPAIRS_INTERVAL_SEC=${MKT_NEWPAIRS_INTERVAL_SEC:-60}
      - MKT_NEWPAIRS_MAX_AGE_MIN=${MKT_NEWPAIRS_MAX_AGE_MIN:-120}
      - MKT_NEWPAIRS_MIN_AGE_MIN=${MKT_NEWPAIRS_MIN_AGE_MIN:-10}
      - MKT_MIN_LIQUIDITY_USD=${MKT_MIN_LIQUIDITY_USD:-10000000}
      - MKT_MIN_VOLUME_USD=${MKT_MIN_VOLUME_USD:-5000000}
      - MKT_ENABLE_MOCK_ONCHAIN=${MKT_ENABLE_MOCK_ONCHAIN:-false}
      - MKT_ENRICH_DEXSCREENER=${MKT_ENRICH_DEXSCREENER:-true}
      - MKT_HTTP_RETRIES=${MKT_HTTP_RETRIES:-3}
      - MKT_HTTP_USER_AGENT=${MKT_HTTP_USER_AGENT:-Meme25-MarketGateway/1.0}
      - MKT_FALLBACK_TOKENS=${MKT_FALLBACK_TOKENS:-So11111111111111111111111111111111111111112}
      - BIRDEYE_API_KEY=${BIRDEYE_API_KEY}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  position_manager:
    build:
      context: .
      dockerfile: Dockerfile.unified
      target: position_manager
    ports:
      - "8083:8083"
    environment:
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/meme25
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    restart: unless-stopped

  strategy_factory:
    build:
      context: .
      dockerfile: Dockerfile.unified
      target: strategy_factory  
    ports:
      - "8084:8084"
    environment:
      - REDIS_URL=redis://redis:6379
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  backtest_engine:
    build:
      context: .
      dockerfile: ./backtest_engine/Dockerfile
    ports:
      - "8000:8000"
    environment:
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/meme25
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    volumes:
      - ./backtest_engine:/app
    restart: unless-stopped

  dashboard:
    build:
      context: .
      dockerfile: ./dashboard/Dockerfile
    ports:
      - "5000:5000"
    environment:
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/meme25
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

volumes:
  redis_data:
  postgres_data: